# 协程02

https://www.bennyhuo.com/2022/03/09/cpp-coroutines-01-intro/

## 1. 协程的状态

协程挂起时，我们需要记录函数执行的位置，C++ 协程会在开始执行时的第一步就使用 `operator new` 来开辟一块内存来存放这些信息，这块内存或者说这个对象又被称为协程的状态（coroutine state）。
协程的状态不仅会被用于存放挂起时的位置（后称为挂起点），也会在协程开始执行时存入协程体的参数值。例如：

```C++
Result Coroutine(int start_value) {
  std::cout << start_value << std::endl;
  co_await std::suspend_always{};
  std::cout << start_value + 1 << std::endl;
};
```

这里的 `start_value` 就会被存入协程的状态当中。

需要注意的是，如果参数是值类型，他们的值或被移动或被复制（取决于类型自身的复制构造和移动构造的定义）到协程的状态当中；如果是引用、指针类型，那么存入协程的状态的值将会是引用或指针本身，而不是其指向的对象，这时候需要开发者自行保证协程在挂起后续恢复执行时参数引用或者指针指向的对象仍然存活。

与创建相对应，在协程执行完成或者被外部主动销毁之后，协程的状态也随之被销毁释放。

协程的状态的创建和销毁都是编译器帮我们处理好的，不需要我们显式的处理。

## **2. 协程的挂起**

协程的挂起是协程的灵魂。C++ 通过 `co_await` 表达式来处理协程的挂起，表达式的操作对象则为等待体（awaiter）。

等待体需要实现三个函数，这三个函数在挂起和恢复时分别调用。
