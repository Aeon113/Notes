# 2024-08-12

## 多副本或纠删码

多副本模式的空间利用率低; 纠删码模式的数据恢复效率低。

## 一个ceph集群可以有多个pool, 每个pool使用不同的replication策略, 使用不同的存储介质。

![1723434288719](image/0002/1723434288719.png)

不过通常每个pool不会独占某些存储设备, 除非你主动让某个设备只被分配进某个pool。

## RADOS 是ceph中high-level storage的基础

![1723434783369](image/0002/1723434783369.png)

## RGW (Rados Gateway): Ceph的对象存储服务

![1723434864833](image/0002/1723434864833.png)

需要强调的是, 对象存储中的对象(object)不是RADOS Object。

![1723435040323](image/0002/1723435040323.png)

## RGW Zone

![1723435227259](image/0002/1723435227259.png)

![1723443345082](image/0002/1723443345082.png)

数个pool被组合成一个zone, 其中每个pool负责存储不同的信息。一些pool中的数据会在各个zone之间同步, 另一些只会在少数zone间(其实是指zone group内部)同步或不向任何zone同步。

![1723453968042](image/0002/1723453968042.png)

## RBD: Rados Block Device

 ![1723454544121](image/0002/1723454544121.png)

![1723454741202](image/0002/1723454741202.png)

![1723454853909](image/0002/1723454853909.png)

## RBD: Journaling Mode 和 RBD Mirroring

![1723454903630](image/0002/1723454903630.png)

Ceph RBD 也可以启用日志系统, 其目的主要是用来启用Mirroring:

![1723455021867](image/0002/1723455021867.png)

RBD Mirroring可以用一个块设备的内容来创建另一个块设备, 整个过程中数据来源的盘不需要进行write block。这个功能可以用来支持 高可用。

## 其他RBD功能

![1723455345481](image/0002/1723455345481.png)

## 访问RBD服务的方式

![1723455904646](image/0002/1723455904646.png)

## CephFS

![1723456317951](image/0002/1723456317951.png)

CephFS的Data会直接从挂载方写入Ceph集群, 而元数据则需要经过元数据服务(MDS)的转发和处理。

## Ceph MDS: Metadata Server

前面说到RGW和RBS时, 除了接入模块以外, 我们只提到了3个ceph模块: OSD, Mon和MGR。

然而在文件系统服务之中, 我们需要引入一个新的文件系统元数据模块: MDS:

![1723456794826](image/0002/1723456794826.png)

MDS是stateless服务, 它的数据全存在RADOS里。

![1723457117847](image/0002/1723457117847.png)

## MDS的横向扩展

![1723457234608](image/0002/1723457234608.png)

一棵文件系统目录树, 被分为了多棵子树。每棵子树都由一个MDS管理。子树和MDS间是多对一的关系。整个子树划分和MDS选取是随负载动态进行的, 而非静态不变的。

## CephFS Snapshots

![1723457489147](image/0002/1723457489147.png)

在创建快照时, ceph会创建一个 `.snap`目录, 然后把快照目录放在这个目录里。

需要使用快照时, 用户可以直接将这个目录复制出来。

如果想删除快照, 则可以直接rmdir。

## CephFS Recursive Accounting

![1723457730504](image/0002/1723457730504.png)

如果你使用 `rbytes` option来挂载一个CephFS, 那么你将可以看到每个目录及其子目录的总空间消耗量, 就像 `du`一样; 此外还能显示目录中的inode数量, 文件ctime等信息。

不过, 由于这个功能会导致 `rsync`之类的工具出现问题, 因此其默认是关闭的。

## CephFS的其它功能

![1723458136483](image/0002/1723458136483.png)

## 访问 CephFS 的方式

![1723458436279](image/0002/1723458436279.png)
